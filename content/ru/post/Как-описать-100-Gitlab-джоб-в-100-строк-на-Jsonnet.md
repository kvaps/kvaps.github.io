---
title: Как описать 100 Gitlab джоб в 100 строк на Jsonnet
date: 2019-12-26 20:15:00
tags:
link: https://habr.com/post/483626/
---

В продолжение [предыдущей статьи](https://habr.com/ru/post/481662/) про инструменты деплоя в Kubernetes, хочу рассказать вам про то как можно использовать Jsonnet для упрощения описания джоб в вашем **.gitlab-ci.yml**

![](https://jsonnet.org/img/isologo.svg)

#### Дано
Есть монорепа, в которой:
* 10 Dockerfiles
* 30 описанных деплоев
* 3 окружения: **devel**, **staging** и **production**

#### Задача
Настроить пайплайн:
* Сборка Docker-образов должна производиться по добавлении git-тэга с версией. 
* Каждая операция деплоя должна выполняться при пуше в ветку окружения и только по изменении файлов в конкретной директории
* В каждом окружении установлен свой gitlab-runner с отдельным тэгом, который выполняет деплой только в своём окружении.
* Не все приложения должны быть задеплоены в каждое из окружений, мы должны описать пайплайн так, чтобы иметь возможность делать исключения.
* Некоторые деплойменты используют git submodule и должны запускаться с установленной переменной **`GIT_SUBMODULE_STRATEGY=normal`**

Как видите, описать это всё может показаться настоящим адом, но мы не отчаиваемся и вооружившись Jsonnet сделаем это легко и непринуждённо. 

<!--more-->
