---
title: 'LVM+QCOW2, или Попытка создать идеальный CSI-драйвер для shared SAN в Kubernetes'
date: 2023-09-01
link: https://habr.com/ru/companies/flant/articles/757864/
---

![](https://habrastorage.org/getpro/habr/upload_files/a3c/872/0fb/a3c8720fb97299f358bc05778f98941f.png)

Несколько месяцев назад у нас появилась необходимость разработать CSI-драйвер для Kubernetes, который в первую очередь использовался бы для хранения дисков виртуальных машин в [Deckhouse Virtualization](https://deckhouse.ru/documentation/v1/modules/490-virtualization/), но также мог бы использоваться и со стандартными контейнерами в Kubernetes. У оборудования наших заказчиков, как правило, есть определенная специфика — чаще всего это классическая SAN (Storage Area Network) с внешним хранилищем и общим shared LUN, который выделяется на несколько узлов. На одном LUN одновременно работает несколько виртуальных машин или контейнеров.

Помимо всего прочего, от драйвера нам требовалась поддержка различных CoW-фичей, таких как снапшоты, thin provisioning и возможность выполнять live-миграцию виртуальных машин в Kubernetes. Из существующих решений можно было бы отметить некоторые свободные проекты, однако ни один из них не реализует все желаемые фичи. Кроме того, у них есть явные проблемы с масштабированием.

<!--more-->
